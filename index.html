<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Spine – Admin (Daily)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@daily-co/daily-js"></script>
  <!-- <script id="access" type="application/json" src="../../../spine-access.json"></script> -->
  <script type="text/javascript">
    
    async function readDailyAdminToken() {
      if (!window.DailyAdminToken) {
        const fileHandle = await self.showOpenFilePicker({
          suggestedName: 'spine-access.json',
          types: [{
            description: '.json file',
            accept: {
              'application/json': ['.json'],
            },
          }],
  //        startIn: 'pictures'
        });
        const file = await fileHandle[0].getFile();
        const textContents = await file.text();
        var jsonContents = JSON.parse(textContents);
        console.log(jsonContents);
        window.DailyAdminToken = jsonContents.dailyAdminToken;
      }
      console.log('window.DailyAdminToken = ' + window.DailyAdminToken);
      document.getElementById("accessBtnId").disabled = jsonContents.dailyAdminToken;
      return window.DailyAdminToken;
    }

    async function lazyFetchDailyAdminToken() {
      if (!window.DailyAdminToken)
        return await readDailyAdminToken();
      return window.DailyAdminToken;
    }

    async function listDailyRooms() {
      var adminToken = await lazyFetchDailyAdminToken();
      if (adminToken) {
        // Define the API URL
        const apiUrl = 'https://api.daily.co/v1/rooms?limit=5';
        const requestOptions = {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
          },
        };

        // Make a GET request
        fetch(apiUrl, requestOptions)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            console.log(data);
            var roomsEl = document.getElementById("rooms");

            var cols = ["created_at", "name"];//, "id", "url"];           
            const rowEl = document.createElement('div');
//            rowEl.classList.add('row');
            for (index = 0; index < cols.length; index++) {
              const cell = document.createElement('div');
//              cell.classList.add('cell');
              cell.innerHTML = cols[index];
              rowEl.appendChild(cell);
            }
            roomsEl.appendChild(rowEl);
            roomsEl.appendChild(document.createElement('br'))

            for (index_ = 0; index_ < data.data.length; index_++) {
              var json_entry = data.data[index_];
              var rowEl_ = document.createElement('div');
//              rowEl_.classList.add('row');

              const createdAtEl = document.createElement('div');
//              createdAtEl.classList.add('cell');
              createdAtEl.innerHTML = json_entry[cols[0]];
              rowEl_.appendChild(createdAtEl);

              const nameEl = document.createElement('div');
              nameEl.innerHTML = json_entry[cols[1]];
//              nameEl.classList.add('cell');
              rowEl_.appendChild(nameEl);

              roomsEl.appendChild(rowEl_)
              roomsEl.appendChild(document.createElement('br'))
            };
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }
    }
  </script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:16px;background:#0b0f14;color:#e6edf3}
    #app{max-width:1100px;margin:0 auto}
    #status{margin-bottom:12px;opacity:.9}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button{background:#1f6feb;color:white;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:14px}
    .tile{position:relative;background:#0d1117;border:1px solid #30363d;border-radius:14px;overflow:hidden}
    .tile header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #30363d;font-size:13px;background:#0b1220}
    video, audio{width:100%;display:block;background:black}
    .hint{font-size:12px;opacity:.8;margin-top:6px}
    .local{outline:2px dashed #30363d}
    .pill{font-size:10px;padding:2px 6px;border-radius:999px;background:#13233a;border:1px solid #2b3f5f}
  </style>
</head>
<body>
<div id="app">
  <div id="status">Forbinder…</div>
  <div class="row">
    <button id="accessBtnId" onclick="readDailyAdminToken()">Read Daily Admin Token</button>
    <button id="listRoomsBtnId" onclick="listDailyRooms()">List Daily Rooms</button>
  </div>
  <h3>Rooms</h3>
  <div id="rooms"></div>

<!--  
  <div class="row">
    <button id="testBtn" disabled>Send test-besked</button>
    <button id="enableAudioBtn" disabled>Aktivér lyd</button>
  </div>
  <div class="hint">Tip: Klik “Aktivér lyd”, hvis du ikke hører noget. Video bør vise uden klik.</div>

  <h3>Remote streams</h3>
  <div id="remoteGrid" class="grid"></div>

  <h3>Lokalt (valgfrit)</h3>
  <div id="localGrid" class="grid"></div>
-->  
</div>

<script>
  // --- Daily setup (receive-only browser viewer) ---
  const callFrame = Daily.createCallObject({
    //subscribeToTracksAutomatically: true
  });

  const statusEl = document.getElementById('status');
/*
  const testBtn = document.getElementById('testBtn');
  const enableAudioBtn = document.getElementById('enableAudioBtn');
  const remoteGrid = document.getElementById('remoteGrid');
  const localGrid  = document.getElementById('localGrid');
*/
  let isJoined = false;

  function updateStatus(msg) {
    statusEl.textContent = msg;
    console.log('[status]', msg);
  }

  /*
  // --- UI helpers ---
  function ensureRemoteTile(participant) {
    const pid = participant.session_id;
    let tile = remoteGrid.querySelector(`.tile[data-pid="${pid}"]`);
    if (!tile) {
      tile = document.createElement('div');
      tile.className = 'tile';
      tile.dataset.pid = pid;
      tile.innerHTML = `
        <header>
          <span>${participant.user_name || 'Deltager'} <span class="pill">id: ${pid.slice(0,6)}</span></span>
          <span id="trackBadges-${pid}" class="pill">venter på spor…</span>
        </header>
        <div class="media"></div>
      `;
      remoteGrid.appendChild(tile);
    }
    return tile;
  }

  function ensureLocalTile() {
    let tile = localGrid.querySelector(`.tile[data-pid="me"]`);
    if (!tile) {
      tile = document.createElement('div');
      tile.className = 'tile local';
      tile.dataset.pid = 'me';
      tile.innerHTML = `
        <header>
          <span>Browser-klient (local)</span>
          <span class="pill">receive-only</span>
        </header>
        <div class="media"></div>
      `;
      localGrid.appendChild(tile);
    }
    return tile;
  }

  function setBadges(pid, kinds) {
    const el = document.getElementById(`trackBadges-${pid}`);
    if (!el) return;
    if (!kinds || kinds.size === 0) el.textContent = 'ingen spor';
    else el.textContent = Array.from(kinds).join(' + ');
  }

  function keyToKind(k) {
    // Map Daily track keys to media element kind
    // 'video' | 'screenVideo' -> 'video', 'audio' | 'screenAudio' -> 'audio'
    return (k === 'video' || k === 'screenVideo') ? 'video' : 'audio';
  }

  // Attach a MediaStreamTrack to a media element (video/audio)
  function attachTrack({ participant, track, kind, isLocal = false, labelSuffix = '' }) {
    const pid = participant?.session_id || (isLocal ? 'me' : 'unknown');
    const tile = isLocal ? ensureLocalTile() : ensureRemoteTile(participant);
    const mediaWrap = tile.querySelector('.media');

    const elId = `${isLocal ? 'local' : 'remote'}-${pid}-${kind}${labelSuffix}`;
    let el = mediaWrap.querySelector(`#${CSS.escape(elId)}`);

    if (!el) {
      if (kind === 'video') {
        el = document.createElement('video');
        el.setAttribute('playsinline', 'playsinline');
        el.autoplay = true;
        el.muted = isLocal; // local preview muted
        el.id = elId;
        mediaWrap.appendChild(el);
      } else if (kind === 'audio') {
        el = document.createElement('audio');
        el.autoplay = true;
        el.id = elId;
        mediaWrap.appendChild(el);
      }
    }

    const ms = el.srcObject instanceof MediaStream ? el.srcObject : new MediaStream();
    // Fjern tidligere track af samme kind
    ms.getTracks().filter(t => t.kind === kind).forEach(t => ms.removeTrack(t));
    if (track) ms.addTrack(track);
    el.srcObject = ms;

    // Forsøg at afspille (audio kan kræve klik)
    el.play().catch(() => {});

    // Badges
    const kinds = new Set(ms.getTracks().map(t => t.kind));
    setBadges(pid, kinds);
  }

  function detachTrack({ participant, kind, isLocal = false }) {
    const pid = participant?.session_id || (isLocal ? 'me' : 'unknown');
    const container = isLocal ? localGrid : remoteGrid;
    const sel = `${isLocal ? 'local' : 'remote'}-${pid}-${kind}`;
    // Kan være flere (fx video + screenVideo deler 'video' kind). Fjern alle matching.
    container.querySelectorAll(`[id^="${sel}"]`).forEach(el => {
      if (el.srcObject) {
        const ms = el.srcObject;
        ms.getTracks().forEach(t => { if (t.kind === kind) ms.removeTrack(t); });
        if (ms.getTracks().length === 0) el.srcObject = null;
        const kinds = new Set(ms.getTracks().map(t => t.kind));
        setBadges(pid, kinds);
      }
    });
  }

  // Eksplicit subscription (hjælper især mod iOS-klienter)
  function subscribeToParticipant(pid) {
    try {
      callFrame.updateParticipant(pid, {
        setSubscribedTracks: { video: true, audio: true, screenVideo: true, screenAudio: true }
      });
    } catch (e) {
      console.warn('updateParticipant failed', e);
    }
  }

  // --- Daily events ---
  callFrame.on('joined-meeting', () => {
    isJoined = true;
    updateStatus('Forbundet til rummet');
    testBtn.disabled = false;
    enableAudioBtn.disabled = false;

    // Tving subscription til alle nuværende deltagere (ikke mig selv)
    const participants = callFrame.participants();
    Object.values(participants).forEach(p => {
      if (!p.local) subscribeToParticipant(p.session_id);
    });

    // Mount eksisterende playable spor (brug persistentTrack)
    Object.values(participants).forEach(p => {
      ['video','audio','screenVideo','screenAudio'].forEach(k => {
        const info = p.tracks?.[k];
        const mtrack = info?.persistentTrack || info?.track;
        if (info && info.state === 'playable' && mtrack) {
          attachTrack({
            participant: p,
            track: mtrack,
            kind: keyToKind(k),
            labelSuffix: k.startsWith('screen') ? '-screen' : ''
          });
        }
      });
    });
  });
  callFrame.on('left-meeting', () => {
    isJoined = false;
    updateStatus('Afbrudt');
    testBtn.disabled = true;
    enableAudioBtn.disabled = true;
    remoteGrid.innerHTML = '';
    localGrid.innerHTML = '';
  });
*/

  callFrame.on('error', (e) => updateStatus(`Fejl: ${e?.errorMsg || e?.message || e}`));
/*
  callFrame.on('participant-joined', (ev) => {
    ensureRemoteTile(ev.participant);
    subscribeToParticipant(ev.participant.session_id);
  });

  callFrame.on('participant-updated', (ev) => {
    const p = ev.participant;
    // Hvis spor bliver playable efterfølgende, montér dem (persistentTrack fallback)
    ['video','audio','screenVideo','screenAudio'].forEach(k => {
      const info = p.tracks?.[k];
      const mtrack = info?.persistentTrack || info?.track;
      if (info && info.state === 'playable' && mtrack) {
        attachTrack({
          participant: p,
          track: mtrack,
          kind: keyToKind(k),
          labelSuffix: k.startsWith('screen') ? '-screen' : ''
        });
      }
    });
  });

  // Brug track-started/track-stopped til at håndtere ændringer live
  callFrame.on('track-started', (ev) => {
    const { participant, kind } = ev;
    const pid = participant?.session_id || ev.participant?.session_id;
    const p = participant || callFrame.participants()[pid];
    // Slå korrekt track op og brug persistentTrack fallback
    const key = (ev.kind === 'video' || ev.track?.kind === 'video') ? 'video' : 'audio';
    const info = p?.tracks?.[key] || p?.tracks?.[(key === 'video') ? 'screenVideo' : 'screenAudio'];
    const mtrack = ev.track || info?.persistentTrack || info?.track;
    if (p && mtrack) {
      attachTrack({
        participant: p,
        track: mtrack,
        kind,
        labelSuffix: (info && (info === p?.tracks?.screenVideo || info === p?.tracks?.screenAudio)) ? '-screen' : ''
      });
    }
  });

  callFrame.on('track-stopped', (ev) => {
    const { participant, kind } = ev;
    detachTrack({ participant, kind });
  });

  callFrame.on('participant-left', (ev) => {
    const pid = ev.participant.session_id;
    const tile = remoteGrid.querySelector(`.tile[data-pid="${pid}"]`);
    if (tile) tile.remove();
  });

  // --- Buttons ---
  testBtn.addEventListener('click', () => {
    if (!isJoined) return updateStatus('Ikke forbundet');
    try {
      callFrame.sendAppMessage({
        date: new Date().toISOString(),
        message: 'Hello from browser!',
      }, '*');
      updateStatus('Sendt: Hello from browser!');
    } catch (err) {
      updateStatus(`Fejl: ${err.message}`);
    }
  });

  enableAudioBtn.addEventListener('click', async () => {
    // Forsøg at afspille alle audio/video elementer (til at “unmute” autoplay-restriktion)
    const mediaEls = remoteGrid.querySelectorAll('audio, video');
    let ok = 0, fail = 0;
    await Promise.all(Array.from(mediaEls).map(async el => {
      el.muted = false; // prøv at fjerne mute for remote
      try { await el.play(); ok++; } catch { fail++; }
    }));
    updateStatus(`Lyd aktiveret (afspiller: ${ok}, afvist: ${fail})`);
  });


  // --- Join rummet (receive-only) ---
  callFrame.join({
    url: "https://veo-labs.daily.co/spine",
    userName: "Browser Client",
    // Browseren sender ikke sit eget kamera/mikrofon; kun modtager
    videoSource: false,
    audioSource: false
  }).catch(err => updateStatus(`Join fejlede: ${err.message}`));

  // Forlad pænt
  window.addEventListener('beforeunload', () => { try { callFrame.leave(); } catch {} });
*/
/*
callFrame.preAuth({
  //url: 'DAILY_ROOM_URL',
  token: '${window.DailyAdminToken}'
});
*/
</script>
</body>
</html>
