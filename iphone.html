<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>iPhone camera viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@daily-co/daily-js"></script>
  <script type="text/javascript" src="gamecontrollers.js"></script>
  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font-family:sans-serif}
    #status{
      position:absolute;top:10px;left:10px;background:rgba(0,0,0,.6);
      padding:6px 10px;border-radius:6px;font-size:14px;z-index:10
    }
    #video-container{
      display:flex;flex-wrap:wrap;gap:1rem;box-sizing:border-box;padding:1rem;
      align-items:flex-start; /* undgå at børn strækkes i højden */
    }
    .video-wrap{
      flex:1 1 48%;max-width:48%;
      aspect-ratio:16/9;            /* Lås rammen til 16:9 */
      position:relative;background:#000;border-radius:.5rem
    }
    @media (max-width: 900px){
      .video-wrap{flex-basis:100%;max-width:100%}
    }
    video{
      width:100%;height:100%;
      object-fit:contain;           /* Vis hele billedet – aldrig crop */
      object-position:center;
      border:0;border-radius:.5rem;background:#000
    }
    .placeholder{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      color:#aaa;font-size:14px;pointer-events:none
    }
    .hidden{display:none}
  </style>
  <style>
    .switch-group {
      position: relative;
      display: block;
      vertical-align: top;
      width: 200px;
      height: 30px;
      padding: 3px;
      margin: 0 10px 10px 0;
      background: linear-gradient(to bottom, #E1B42B, #E1B42B 25px);
      background-image: -webkit-linear-gradient(top, #E1B42B, #E1B42B 25px);
      border-radius: 1px;
      box-shadow: inset 0 -1px #E1B42B, inset 0 1px 1px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      box-sizing:content-box;
    }
    .switch-group-input {
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      box-sizing:content-box;
    }
    .switch-group-label {
      position: relative;
      display: block;
      height: inherit;
      font-size: 10px;
      text-transform: uppercase;
      background: #eceeef;
      border-radius: inherit;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.12), inset 0 0 2px rgba(0, 0, 0, 0.15);
      box-sizing:content-box;
    }
    .switch-group-label:before, .switch-group-label:after {
      position: absolute;
      top: 50%;
      margin-top: -.5em;
      line-height: 1;
      -webkit-transition: inherit;
      -moz-transition: inherit;
      -o-transition: inherit;
      transition: inherit;
      box-sizing:content-box;
    }
    .switch-group-label:before {
      content: attr(data-off);
      right: 21px;
      color: #aaaaaa;
      text-shadow: 0 1px rgba(255, 255, 255, 0.5);
    }
    .switch-group-label:after {
      content: attr(data-on);
      left: 21px;
      color: #FFFFFF;
      text-shadow: 0 1px rgba(0, 0, 0, 0.2);
      opacity: 0;
    }
    .switch-group-input:checked ~ .switch-group-label {
      background: #E1B42B;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.15), inset 0 0 3px rgba(0, 0, 0, 0.2);
    }
    .switch-group-input:checked ~ .switch-group-label:before {
      opacity: 0;
    }
    .switch-group-input:checked ~ .switch-group-label:after {
      opacity: 1;
    }
    .switch-group-input:checked {
      left: 174px;
      box-shadow: -1px 1px 5px rgba(0, 0, 0, 0.2);
    }
    .switch {
      position: relative;
      display: inline-block;
      vertical-align: top;
      width: 200px;
      height: 30px;
      padding: 3px;
      margin: 0 10px 10px 0;
      background: linear-gradient(to bottom, #eeeeee, #FFFFFF 25px);
      background-image: -webkit-linear-gradient(top, #eeeeee, #FFFFFF 25px);
      border-radius: 18px;
      box-shadow: inset 0 -1px white, inset 0 1px 1px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      box-sizing:content-box;
    }
    .switch-input {
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      box-sizing:content-box;
    }
    .switch-label {
      position: relative;
      display: block;
      height: inherit;
      font-size: 10px;
      text-transform: uppercase;
      background: #eceeef;
      border-radius: inherit;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.12), inset 0 0 2px rgba(0, 0, 0, 0.15);
      box-sizing:content-box;
    }
    .switch-label:before, .switch-label:after {
      position: absolute;
      top: 50%;
      margin-top: -.5em;
      line-height: 1;
      -webkit-transition: inherit;
      -moz-transition: inherit;
      -o-transition: inherit;
      transition: inherit;
      box-sizing:content-box;
    }
    .switch-label:before {
      content: attr(data-off);
      right: 11px;
      color: #aaaaaa;
      text-shadow: 0 1px rgba(255, 255, 255, 0.5);
    }
    .switch-label:after {
      content: attr(data-on);
      left: 11px;
      color: #FFFFFF;
      text-shadow: 0 1px rgba(0, 0, 0, 0.2);
      opacity: 0;
    }
    .switch-input:checked ~ .switch-label {
      background: #E1B42B;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.15), inset 0 0 3px rgba(0, 0, 0, 0.2);
    }
    .switch-input:checked ~ .switch-label:before {
      opacity: 0;
    }
    .switch-input:checked ~ .switch-label:after {
      opacity: 1;
    }
    .switch-handle {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 28px;
      height: 28px;
      background: linear-gradient(to bottom, #FFFFFF 40%, #f0f0f0);
      background-image: -webkit-linear-gradient(top, #FFFFFF 40%, #f0f0f0);
      border-radius: 100%;
      box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2);
    }
    .switch-handle:before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      margin: -6px 0 0 -6px;
      width: 12px;
      height: 12px;
      background: linear-gradient(to bottom, #eeeeee, #FFFFFF);
      background-image: -webkit-linear-gradient(top, #eeeeee, #FFFFFF);
      border-radius: 6px;
      box-shadow: inset 0 1px rgba(0, 0, 0, 0.02);
    }
    .switch-input:checked ~ .switch-handle {
      left: 174px;
      box-shadow: -1px 1px 5px rgba(0, 0, 0, 0.2);
    }
    
    /* Transition
    ========================== */
    .switch-label, .switch-handle {
      transition: All 0.3s ease;
      -webkit-transition: All 0.3s ease;
      -moz-transition: All 0.3s ease;
      -o-transition: All 0.3s ease;
    }    
    .switch-group-label {
      transition: All 0.3s ease;
      -webkit-transition: All 0.3s ease;
      -moz-transition: All 0.3s ease;
      -o-transition: All 0.3s ease;
    }    
  </style>
</head>
<body>
  <div id="browserStatus">Browser: ?</div>
  <div id="phoneStatus">Phone: ?</div>

  <div id="video-container">
    <div class="video-wrap">
      <video id="vWide"  playsinline autoplay muted></video>
      <div id="phWide"  class="placeholder">Ingen wide video</div>
    </div>
    <div class="video-wrap">
      <video id="vUltra" playsinline autoplay muted></video>
      <div id="phUltra" class="placeholder">Ingen ultra-wide video</div>
    </div>
  </div>

  <div id="phone-settings-container"">
    <div class="phone-settings-wrap">
      <label class="switch-group">
        <input id="settingsGroupWebRtc" class="switch-group-input" type="checkbox" onchange="settingsWebUserGroupToggle(this)" />
        <span class="switch-group-label" data-on="Web RTC Settings" data-off="Web RTC Settings"></span> 
      </label>
      <label id="settingsDailyStreamWideLabel" class="switch">
        <input id="settingsDailyStreamWide" class="switch-input" type="checkbox" onchange="settingsWebUserChangedPropertyDailyStreamWide(this)" />
        <span class="switch-label" data-on="DailyStreamWide - On" data-off="DailyStreamWide - Off"></span> 
        <span class="switch-handle"></span> 
      </label>
      <label id="settingsDailyStreamUltraLabel" class="switch">
        <input id="settingsDailyStreamUltra" class="switch-input" type="checkbox" onchange="settingsWebUserChangedPropertyDailyStreamUltra(this)" />
        <span class="switch-label" data-on="DailyStreamUltra - On" data-off="DailyStreamUltra - Off"></span> 
        <span class="switch-handle"></span> 
      </label>
      <label id="settingsGameControllerLabel" class="switch">
        <input id="settingsGameController" class="switch-input" type="checkbox" onchange="settingsWebUserChangedPropertyGameController(this)" />
        <span class="switch-label" data-on="GameController - On" data-off="GameController - Off"></span> 
        <span class="switch-handle"></span> 
      </label>
    </div>
  </div>

  <script>
    const params   = new URLSearchParams(window.location.search);
    const roomName = params.get("name");
    const browserStatusEl = document.getElementById("browserStatus");
    const phoneStatusEl = document.getElementById("phoneStatus");
    const vWide    = document.getElementById("vWide");
    const vUltra   = document.getElementById("vUltra");
    const phWide   = document.getElementById("phWide");
    const phUltra  = document.getElementById("phUltra");
    const phoneSettingsDailyStreamWideEl = document.getElementById("settingsDailyStreamWide");
    const phoneSettingsDailyStreamUltraEl = document.getElementById("settingsDailyStreamUltra");
    const phoneSettingsGameControllerEl = document.getElementById("settingsGameController");
    const settingsGroupWebRtcEl = document.getElementById("settingsGroupWebRtc");
    const phoneSettingsDailyStreamWideLabelEl = document.getElementById("settingsDailyStreamWideLabel");
    const phoneSettingsDailyStreamUltraLabelEl = document.getElementById("settingsDailyStreamUltraLabel");
    const phoneSettingsGameControllerLabelEl = document.getElementById("settingsGameControllerLabel");

    // Daily api handle
    var call = null;
    // Vis wide/ultra fra første remote, der har disse spor
    let targetSessionId = null;

    // Gamepad changes are sent to Daily as messages
    const onGamePadChange_debug = true;
    function onGamePadDataChange() {
      while(0 < gamePadData_changes.length) {
        const gamePadDataChange = gamePadData_changes.shift();
        if (onGamePadChange_debug) console.log("onGamePadDataChange: update#" + gamePadDataChange.update_index + ", changes=" + JSON.stringify(gamePadDataChange));
        if (call) call.sendAppMessage(gamePadDataChange, '*');
      }
    };
    gamePadData_changesCallback = onGamePadDataChange;

    var phoneSettingsData = {};
    function updatePhoneSettingsUI() {

      let isPhoneConnected = (targetSessionId !== null);
      let isGameControllerEnabled = isPhoneConnected && "gameController" in phoneSettingsData && phoneSettingsData.gameController;
      let isDailyStreamWideEnabled = isPhoneConnected && "DailyStreamWide" in phoneSettingsData && phoneSettingsData.DailyStreamWide;
      let isDailyStreamUltraEnabled = isPhoneConnected && "DailyStreamUltra" in phoneSettingsData && phoneSettingsData.DailyStreamUltra;

      if (isPhoneConnected) 
        phoneStatusEl.textContent = "Phone: Connected ✓";
      else
        phoneStatusEl.textContent = "Phone: Disconnected"
      phoneSettingsDailyStreamWideEl.disabled = !(isPhoneConnected);
      phoneSettingsDailyStreamWideEl.checked = isDailyStreamWideEnabled;
      phoneSettingsDailyStreamUltraEl.disabled = !(isPhoneConnected);
      phoneSettingsDailyStreamUltraEl.checked = isDailyStreamUltraEnabled;
      phoneSettingsGameControllerEl.disabled = !(isPhoneConnected);
      phoneSettingsGameControllerEl.checked = isGameControllerEnabled;
      
      let displayVal = settingsGroupWebRtcEl.checked ? 'inline-block' : 'none';
      phoneSettingsDailyStreamWideLabelEl.style.display = displayVal;
      phoneSettingsDailyStreamUltraLabelEl.style.display = displayVal;
      phoneSettingsGameControllerLabelEl.style.display = displayVal;      
    }
    settingsGroupWebRtcEl.checked = true;
    updatePhoneSettingsUI();


    if (!roomName) {
      browserStatusEl.textContent = "Browser: Error! no room name (?name=…)";
      throw new Error("Missing ?name param");
    }
    const roomUrl = `https://veo-labs.daily.co/${encodeURIComponent(roomName)}`;

    // Minimal call-objekt (ingen iframe)
    call = window.DailyIframe.createCallObject({
      subscribeToTracksAutomatically: true
    });

    const attached = { vWide: null, vUltra: null };

    function attachTrack(el, placeholder, mediaTrack) {
      if (!mediaTrack) return;
      if (attached[el.id] === mediaTrack.id) return;
      attached[el.id] = mediaTrack.id;
      el.srcObject = new MediaStream([mediaTrack]);
      placeholder.classList.add("hidden");
      const tryPlay = () => el.play().catch(()=>{});
      if (el.readyState >= 1) tryPlay(); else el.onloadedmetadata = tryPlay;
    }

    function detach(el, placeholder) {
      el.srcObject = null;
      attached[el.id] = null;
      placeholder.classList.remove("hidden");
    }
    function detachAll() {
      detach(vWide, phWide);
      detach(vUltra, phUltra);
    }

    function maybeAttachFor(p) {
      if (!p || p.local) return;

      if (!targetSessionId) { // && (p.tracks?.wide || p.tracks?.ultraWide)) {
        targetSessionId = p.session_id;
      }
      if (p.session_id !== targetSessionId) return;

      const wide  = p.tracks?.wide;
      const ultra = p.tracks?.ultraWide;

      const wideTrack  = wide?.persistentTrack  || wide?.track;
      const ultraTrack = ultra?.persistentTrack || ultra?.track;

      if (wide?.state === "playable" && wideTrack)  attachTrack(vWide,  phWide,  wideTrack);
      else detach(vWide, phWide);

      if (ultra?.state === "playable" && ultraTrack) attachTrack(vUltra, phUltra, ultraTrack);
      else detach(vUltra, phUltra);

    }

    function handleAppMessage(ev) {
        //console.log("handleAppMessage: ev=" + ev)
        if (ev && ev.data) {
          phoneSettingsData = ev.data;
        }
        updatePhoneSettingsUI();
    }
    function settingsWebUserGroupToggle(obj) {
      updatePhoneSettingsUI();    
    }
    function settingsWebUserChangedPropertyDailyStreamWide(obj) {
      if ("gameController" in phoneSettingsData) {
        phoneSettingsData.DailyStreamWide = obj.checked;
        settingsDataSendToPhone();
      }
    }
    function settingsWebUserChangedPropertyDailyStreamUltra(obj) {
      if ("gameController" in phoneSettingsData) {
        phoneSettingsData.DailyStreamUltra = obj.checked;
        settingsDataSendToPhone();
      }
    }
    function settingsWebUserChangedPropertyGameController(obj) {
      if ("gameController" in phoneSettingsData) {
        phoneSettingsData.gameController = obj.checked;
        settingsDataSendToPhone();
      }
    }
    function settingsDataSendToPhone() {
      if (call) call.sendAppMessage(phoneSettingsData, '*');
    }
    function settingsDataRequestLatestFromPhone() {
      if (call) call.sendAppMessage({ "settingsRequestLatest" : true }, '*');
    }
    call
      .on("joining-meeting", () => {
        browserStatusEl.textContent = "Browser: Joining room…";
        updatePhoneSettingsUI()
      })
      .on("joined-meeting",  () => { 
        browserStatusEl.textContent = "Browser: Connected ✓";
        updatePhoneSettingsUI()
      })
      .on("left-meeting",    () => { 
        browserStatusEl.textContent = "Browser: Disconnected"; 
        detachAll(); 
        updatePhoneSettingsUI();
      })
      .on("error", e => browserStatusEl.textContent = "Browser: Error! " + (e?.errorMsg || e?.message || e))
      .on("participant-joined",  ev => {
        maybeAttachFor(ev.participant);
        updatePhoneSettingsUI();
      })
      .on("participant-updated", ev => maybeAttachFor(ev.participant))
      .on("participant-left",    ev => {
        if (ev?.participant?.session_id === targetSessionId) {
          targetSessionId = null;
          phoneSettingsData = {};
          detachAll();
        }
        updatePhoneSettingsUI();
      })
      .on("app-message", ev => handleAppMessage(ev));

    call.join({
      url: roomUrl,
      startAudioOff: true,
      startVideoOff: true
    }).then(() => {
      // Håndter deltagere der allerede er i rummet
      const parts = call.participants();
      Object.values(parts).forEach(p => maybeAttachFor(p));
      setTimeout(function() {
        settingsDataRequestLatestFromPhone()
      }, 1000); // This is ugly - but I can't figure out when it is ok to send request :(
    }).catch(err => {
      browserStatusEl.textContent = "Error: " + (err?.errorMsg || err?.message || err);
    });

  </script>
</body>
</html>
