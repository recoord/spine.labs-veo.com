<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>iPhone camera viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@daily-co/daily-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega@6.1.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@6.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@7.0.2"></script>
  <script type="text/javascript" src="gamecontrollers.js"></script>
  <style media="screen">
      /* Add space between Vega-Embed links  */
      .vega-actions a {
        margin-right: 5px;
      }
  </style>
  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font-family:sans-serif}
    #status{
      position:absolute;top:10px;left:10px;background:rgba(0,0,0,.6);
      padding:6px 10px;border-radius:6px;font-size:14px;z-index:10
    }
    #video-container{
      display:flex;flex-wrap:wrap;gap:1rem;box-sizing:border-box;padding:1rem;
      align-items:flex-start; /* undgå at børn strækkes i højden */
    }
    .video-wrap{
      flex:1 1 48%;max-width:48%;
      aspect-ratio:16/9;            /* Lås rammen til 16:9 */
      position:relative;background:#000;border-radius:.5rem
    }
    @media (max-width: 900px){
      .video-wrap{flex-basis:100%;max-width:100%}
    }
    video{
      width:100%;height:100%;
      object-fit:contain;           /* Vis hele billedet – aldrig crop */
      object-position:center;
      border:0;border-radius:.5rem;background:#000
    }
    .placeholder{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      color:#aaa;font-size:14px;pointer-events:none
    }
    .hidden{display:none}
  </style>
  <style>
    .switch-group {
      position: relative;
      display: block;
      vertical-align: top;
      width: 150px;
      height: 20px;
      padding: 3px;
      margin: 0 10px 10px 0;
      background: linear-gradient(to bottom, #E1B42B, #E1B42B 25px);
      background-image: -webkit-linear-gradient(top, #E1B42B, #E1B42B 25px);
      border-radius: 1px;
      box-shadow: inset 0 -1px #E1B42B, inset 0 1px 1px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      box-sizing:content-box;
    }
    .switch-group-input {
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      box-sizing:content-box;
    }
    .switch-group-label {
      position: relative;
      display: block;
      height: inherit;
      font-size: 9px;
      text-transform: uppercase;
      background: #eceeef;
      border-radius: inherit;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.12), inset 0 0 2px rgba(0, 0, 0, 0.15);
      box-sizing:content-box;
    }
    .switch-group-label:before, .switch-group-label:after {
      position: absolute;
      top: 50%;
      margin-top: -.5em;
      line-height: 1;
      -webkit-transition: inherit;
      -moz-transition: inherit;
      -o-transition: inherit;
      transition: inherit;
      box-sizing:content-box;
    }
    .switch-group-label:before {
      content: attr(data-off);
      left: 21px;
      color: #888888;
      text-shadow: 0 1px rgba(255, 255, 255, 0.5);
    }
    .switch-group-label:after {
      content: attr(data-on);
      right: 21px;
      color: #FFFFFF;
      text-shadow: 0 1px rgba(0, 0, 0, 0.2);
      opacity: 0;
    }
    .switch-group-input:checked ~ .switch-group-label {
      background: #E1B42B;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.15), inset 0 0 3px rgba(0, 0, 0, 0.2);
    }
    .switch-group-input:checked ~ .switch-group-label:before {
      opacity: 0;
    }
    .switch-group-input:checked ~ .switch-group-label:after {
      opacity: 1;
    }
    .switch-group-input:checked {
      left: 174px;
      box-shadow: -1px 1px 5px rgba(0, 0, 0, 0.2);
    }
    .switch {
      position: relative;
      display: inline-block;
      vertical-align: top;
      width: 150px;
      height: 20px;
      padding: 3px;
      margin: 0 10px 10px 0;
      background: linear-gradient(to bottom, #eeeeee, #FFFFFF 25px);
      background-image: -webkit-linear-gradient(top, #eeeeee, #FFFFFF 25px);
      border-radius: 18px;
      box-shadow: inset 0 -1px white, inset 0 1px 1px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      box-sizing:content-box;
    }
    .switch-input {
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      box-sizing:content-box;
    }
    .switch-label {
      position: relative;
      display: block;
      height: inherit;
      font-size: 7px;
      text-transform: uppercase;
      background: #eceeef;
      border-radius: inherit;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.12), inset 0 0 2px rgba(0, 0, 0, 0.15);
      box-sizing:content-box;
    }
    .switch-label:before, .switch-label:after {
      position: absolute;
      top: 50%;
      margin-top: -.5em;
      line-height: 1;
      -webkit-transition: inherit;
      -moz-transition: inherit;
      -o-transition: inherit;
      transition: inherit;
      box-sizing:content-box;
    }
    .switch-label:before {
      content: attr(data-off);
      right: 11px;
      color: #888888;
      text-shadow: 0 1px rgba(255, 255, 255, 0.5);
    }
    .switch-label:after {
      content: attr(data-on);
      left: 11px;
      color: #FFFFFF;
      text-shadow: 0 1px rgba(0, 0, 0, 0.2);
      opacity: 0;
    }
    .switch-input:checked ~ .switch-label {
      background: #E1B42B;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.15), inset 0 0 3px rgba(0, 0, 0, 0.2);
    }
    .switch-input:checked ~ .switch-label:before {
      opacity: 0;
    }
    .switch-input:checked ~ .switch-label:after {
      opacity: 1;
    }
    .switch-input:disabled ~ .switch-label:before {
      color: #cccccc;
    }
    .switch-handle {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 18px;
      height: 18px;
      background: linear-gradient(to bottom, #FFFFFF 40%, #f0f0f0);
      background-image: -webkit-linear-gradient(top, #FFFFFF 40%, #f0f0f0);
      border-radius: 100%;
      box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2);
    }
    .switch-handle:before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      margin: -6px 0 0 -6px;
      width: 12px;
      height: 12px;
      background: linear-gradient(to bottom, #eeeeee, #FFFFFF);
      background-image: -webkit-linear-gradient(top, #eeeeee, #FFFFFF);
      border-radius: 6px;
      box-shadow: inset 0 1px rgba(0, 0, 0, 0.02);
    }
    .switch-input:checked ~ .switch-handle {
      left: 134px;
      box-shadow: -1px 1px 5px rgba(0, 0, 0, 0.2);
    }
    .switch-input:disabled ~ .switch-handle {
      top: 12px;
      left: 12px;
      width: 0px;
      height: 0px;
    }
    .switch-input:disabled ~ .switch-handle:before {
      top: 12px;
      left: 12px;
      width: 0px;
      height: 0px;
    }

    /* Transition
    ========================== */
    .switch-label, .switch-handle {
      transition: All 0.3s ease;
      -webkit-transition: All 0.3s ease;
      -moz-transition: All 0.3s ease;
      -o-transition: All 0.3s ease;
    }    
    .switch-group-label {
      transition: All 0.3s ease;
      -webkit-transition: All 0.3s ease;
      -moz-transition: All 0.3s ease;
      -o-transition: All 0.3s ease;
    }    
  </style>
</head>
<body>
  <div id="browserStatus">Browser: ?</div>
  <div id="phoneStatus">Phone: ?</div>

  <div id="video-container">
    <div class="video-wrap">
      <video id="vWide"  playsinline autoplay muted></video>
      <div id="phWide"  class="placeholder">Ingen wide video</div>
    </div>
    <div class="video-wrap">
      <video id="vUltra" playsinline autoplay muted></video>
      <div id="phUltra" class="placeholder">Ingen ultra-wide video</div>
    </div>
  </div>

  <div id="video-container">

    <div id="phone-metrics-container" class="video-wrap">
      <div id="phone-metrics-placeholder">
      </div>
      <div id="phone-metrics-plot">
        <label class="switch-group">
          <input id="metricsGroupPlot" class="switch-group-input" type="checkbox" onchange="updatePhoneMetricsUI()" />
          <span class="switch-group-label" data-on="Plot" data-off="Plot"></span> 
        </label>
        <label id="phoneMetricsTogglePlottingLabel" class="switch">
          <input id="phoneMetricsTogglePlotting" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="Running" data-off="Paused"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="phoneMetricsClearLabel" class="switch">
          <input id="phoneMetricsClear" class="switch-group-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="Clear" data-off="Clear"></span> 
        </label>
      </div>

      <div id="phone-metrics-series">
        <label class="switch-group">
          <input id="metricsGroupSeries" class="switch-group-input" type="checkbox" onchange="updatePhoneMetricsUI()" />
          <span class="switch-group-label" data-on="Series" data-off="Series"></span> 
        </label>

        <label id="phoneMetricsToggleFpsWideLabel" class="switch">
          <input id="phoneMetricsToggleFpsWide" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="fpsWide - On" data-off="fpsWide - Off"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="phoneMetricsToggleFpsUltraLabel" class="switch">
          <input id="phoneMetricsToggleFpsUltra" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="fpsUltra - On" data-off="fpsUltra - Off"></span> 
          <span class="switch-handle"></span> 
        </label>

        <label id="phoneMetricsToggleThermalStateLabel" class="switch">
          <input id="phoneMetricsToggleThermalState" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="thermalState - On" data-off="thermalState - Off"></span> 
          <span class="switch-handle"></span> 
        </label>

        <label id="phoneMetricsToggleBatteryPercentageLabel" class="switch">
          <input id="phoneMetricsToggleBatteryPercentage" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="batteryPercentage - On" data-off="batteryPercentage - Off"></span> 
          <span class="switch-handle"></span> 
        </label>

        <label id="phoneMetricsToggleDockkitBatteryPercentageLabel" class="switch">
          <input id="phoneMetricsToggleDockkitBatteryPercentage" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="dockkitBatteryPercentage - On" data-off="dockkitBatteryPercentage - Off"></span> 
          <span class="switch-handle"></span> 
        </label>

        <label id="phoneMetricsTogglePitchDegreesLabel" class="switch">
          <input id="phoneMetricsTogglePitchDegrees" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="pitchDegrees - On" data-off="pitchDegrees - Off"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="phoneMetricsToggleYawDegreesLabel" class="switch">
          <input id="phoneMetricsToggleYawDegrees" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="yawDegrees - On" data-off="yawDegrees - Off"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="phoneMetricsToggleRollDegreesLabel" class="switch">
          <input id="phoneMetricsToggleRollDegrees" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="rollDegrees - On" data-off="rollDegrees - Off"></span> 
          <span class="switch-handle"></span> 
        </label>

        <label id="phoneMetricsTogglePitchDegreesPerSecsLabel" class="switch">
          <input id="phoneMetricsTogglePitchDegreesPerSecs" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="pitchDegreesPerSecs - On" data-off="pitchDegreesPerSecs - Off"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="phoneMetricsToggleYawDegreesPerSecsLabel" class="switch">
          <input id="phoneMetricsToggleYawDegreesPerSecs" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="yawDegreesPerSecs - On" data-off="yawDegreesPerSecs - Off"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="phoneMetricsToggleRollDegreesPerSecsLabel" class="switch">
          <input id="phoneMetricsToggleRollDegreesPerSecs" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="rollDegreesPerSecs - On" data-off="rollDegreesPerSecs - Off"></span> 
          <span class="switch-handle"></span> 
        </label>

        <label id="phoneMetricsToggleZoomFactorWideLabel" class="switch">
          <input id="phoneMetricsToggleZoomFactorWide" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="zoomFactorWide - On" data-off="zoomFactorWide - Off"></span> 
          <span class="switch-handle"></span> 
        </label>

      </div>
    </div>


    <div id="phone-settings-container" class="video-wrap">
      <div id="phone-settings-app">
        <label class="switch-group">
          <input id="settingsGroupApp" class="switch-group-input" type="checkbox" onchange="updatePhoneSettingsUI()" />
          <span class="switch-group-label" data-on="App" data-off="App"></span> 
        </label>
        <label id="settingsCustomerBuildLabel" class="switch">
          <input id="settingsCustomerBuild" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="customerBuild" data-off="customerBuild"></span> 
          <span class="switch-handle"></span> 
        </label>
      </div>
      <div id="phone-settings-ai">
        <label class="switch-group">
          <input id="settingsGroupAI" class="switch-group-input" type="checkbox" onchange="updatePhoneSettingsUI()" />
          <span class="switch-group-label" data-on="AI" data-off="AI"></span> 
        </label>
        <label id="settingsOverlayEnableAILabel" class="switch">
          <input id="settingsOverlayEnableAI" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="overlayEnableAI" data-off="overlayEnableAI"></span> 
          <span class="switch-handle"></span> 
        </label>
      </div>
      <div id="phone-settings-capture">
        <label class="switch-group">
          <input id="settingsGroupCapture" class="switch-group-input" type="checkbox" onchange="updatePhoneSettingsUI()" />
          <span class="switch-group-label" data-on="Capture" data-off="Capture"></span> 
        </label>
        <label id="settingsCaptureWideLabel" class="switch">
          <input id="settingsCaptureWide" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="captureWide" data-off="captureWide"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="settingsSaveWideLabel" class="switch">
          <input id="settingsSaveWide" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="saveWide" data-off="saveWide"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="settingsCaptureUltraLabel" class="switch">
          <input id="settingsCaptureUltra" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="captureUltra" data-off="captureUltra"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="settingsSaveUltraLabel" class="switch">
          <input id="settingsSaveUltra" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="saveUltra" data-off="saveUltra"></span> 
          <span class="switch-handle"></span> 
        </label>
      </div>
      <div id="phone-settings-youtube">
        <label class="switch-group">
          <input id="settingsGroupYouTube" class="switch-group-input" type="checkbox" onchange="updatePhoneSettingsUI()" />
          <span class="switch-group-label" data-on="YouTube" data-off="YouTube"></span> 
        </label>
        <label id="settingsYouTubeStreamLabel" class="switch">
          <input id="settingsYouTubeStream" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="YouTubeStream" data-off="YouTubeStream"></span> 
          <span class="switch-handle"></span> 
        </label>
      </div>
      <div id="phone-settings-twitch">
        <label class="switch-group">
          <input id="settingsGroupTwitch" class="switch-group-input" type="checkbox" onchange="updatePhoneSettingsUI()" />
          <span class="switch-group-label" data-on="Twitch" data-off="Twitch"></span> 
        </label>
        <label id="settingsTwitchStreamLabel" class="switch">
          <input id="settingsTwitchStream" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="TwitchStream" data-off="TwitchStream"></span> 
          <span class="switch-handle"></span> 
        </label>
      </div>
      <div id="phone-settings-webrtc">
        <label class="switch-group">
          <input id="settingsGroupWebRtc" class="switch-group-input" type="checkbox" onchange="updatePhoneSettingsUI()" />
          <span class="switch-group-label" data-on="Web RTC" data-off="Web RTC"></span> 
        </label>
        <label id="settingsDailyStreamWideLabel" class="switch">
          <input id="settingsDailyStreamWide" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="DailyStreamWide" data-off="DailyStreamWide"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="settingsDailyStreamUltraLabel" class="switch">
          <input id="settingsDailyStreamUltra" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="DailyStreamUltra" data-off="DailyStreamUltra"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="settingsGameControllerLabel" class="switch">
          <input id="settingsGameController" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="GameController" data-off="GameController"></span> 
          <span class="switch-handle"></span> 
        </label>
      </div>
      <div id="phone-settings-recordingstorage">
        <label class="switch-group">
          <input id="settingsGroupRecordingStorage" class="switch-group-input" type="checkbox" onchange="updatePhoneSettingsUI()" />
          <span class="switch-group-label" data-on="Recording Storage" data-off="Recording Storage"></span> 
        </label>
        <label id="settingsInternalStorageLabel" class="switch">
          <input id="settingsInternalStorage" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="InternalStorage" data-off="InternalStorage"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="settingsExternalStorageLabel" class="switch">
          <input id="settingsExternalStorage" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="ExternalStorage" data-off="ExternalStorage"></span> 
          <span class="switch-handle"></span> 
        </label>
        <label id="settingsCloudStorageLabel" class="switch">
          <input id="settingsCloudStorage" class="switch-input" type="checkbox" onchange="settingsWebUserChangedProperty(this)" />
          <span class="switch-label" data-on="CloudStorage" data-off="CloudStorage"></span> 
          <span class="switch-handle"></span> 
        </label>

      </div>
      <div id="phone-settings-version">Settings Version: ?</div>
    </div>

  </div>

  <script>
    const params   = new URLSearchParams(window.location.search);
    const roomName = params.get("name");
    const browserStatusEl = document.getElementById("browserStatus");
    const phoneStatusEl = document.getElementById("phoneStatus");
    const vWide    = document.getElementById("vWide");
    const vUltra   = document.getElementById("vUltra");
    const phWide   = document.getElementById("phWide");
    const phUltra  = document.getElementById("phUltra");


    const phoneMetricsGroupPlotEl = document.getElementById("metricsGroupPlot");
    const phoneMetricsTogglePlottingLabelEl = document.getElementById("phoneMetricsTogglePlottingLabel");
    const phoneMetricsTogglePlottingEl = document.getElementById("phoneMetricsTogglePlotting");
    const phoneMetricsClearLabelEl = document.getElementById("phoneMetricsClearLabel");

    const phoneMetricsGroupSeriesEl = document.getElementById("metricsGroupSeries");
    const phoneMetricsToggleFpsWideLabelEl = document.getElementById("phoneMetricsToggleFpsWideLabel")
    const phoneMetricsToggleFpsWideEl = document.getElementById("phoneMetricsToggleFpsWide")
    const phoneMetricsToggleFpsUltraLabelEl = document.getElementById("phoneMetricsToggleFpsUltraLabel")
    const phoneMetricsToggleFpsUltraEl = document.getElementById("phoneMetricsToggleFpsUltra")
    const phoneMetricsToggleThermalStateLabelEl = document.getElementById("phoneMetricsToggleThermalStateLabel")
    const phoneMetricsToggleThermalStateEl = document.getElementById("phoneMetricsToggleThermalState")
    const phoneMetricsToggleBatteryPercentageLabelEl = document.getElementById("phoneMetricsToggleBatteryPercentageLabel")
    const phoneMetricsToggleBatteryPercentageEl = document.getElementById("phoneMetricsToggleBatteryPercentage")
    const phoneMetricsToogleDockkitBatteryPercentageLabelEl = document.getElementById("phoneMetricsToggleDockkitBatteryPercentageLabel")
    const phoneMetricsToggleDockkitBatteryPercentageEl = document.getElementById("phoneMetricsToggleDockkitBatteryPercentage")
    const phoneMetricsTogglePitchDegreesLabelEl = document.getElementById("phoneMetricsTogglePitchDegreesLabel")
    const phoneMetricsTogglePitchDegreesEl = document.getElementById("phoneMetricsTogglePitchDegrees")
    const phoneMetricsToggleYawDegreesLabelEl = document.getElementById("phoneMetricsToggleYawDegreesLabel")
    const phoneMetricsToggleYawDegreesEl = document.getElementById("phoneMetricsToggleYawDegrees")
    const phoneMetricsToggleRollDegreesLabelEl = document.getElementById("phoneMetricsToggleRollDegreesLabel")
    const phoneMetricsToggleRollDegreesEl = document.getElementById("phoneMetricsToggleRollDegrees")
    const phoneMetricsTogglePitchDegreesPerSecsLabelEl = document.getElementById("phoneMetricsTogglePitchDegreesPerSecsLabel")
    const phoneMetricsTogglePitchDegreesPerSecsEl = document.getElementById("phoneMetricsTogglePitchDegreesPerSecs")
    const phoneMetricsToggleYawDegreesPerSecsLabelEl = document.getElementById("phoneMetricsToggleYawDegreesPerSecsLabel")
    const phoneMetricsToggleYawDegreesPerSecsEl = document.getElementById("phoneMetricsToggleYawDegreesPerSecs")
    const phoneMetricsToggleRollDegreesPerSecsLabelEl = document.getElementById("phoneMetricsToggleRollDegreesPerSecsLabel")
    const phoneMetricsToggleRollDegreesPerSecsEl = document.getElementById("phoneMetricsToggleRollDegreesPerSecs")
    const phoneMetricsToogleZoomFactorWideLabelEl = document.getElementById("phoneMetricsToggleZoomFactorWideLabel")
    const phoneMetricsToggleZoomFactorWideEl = document.getElementById("phoneMetricsToggleZoomFactorWide")


    const phoneSettingsVersionEl = document.getElementById("phone-settings-version");

    const phoneSettingsGroupAppEl = document.getElementById("settingsGroupApp");
    const phoneSettingsCustomerBuildLabelEl = document.getElementById("settingsCustomerBuildLabel");
    const phoneSettingsCustomerBuildEl = document.getElementById("settingsCustomerBuild");

    const phoneSettingsGroupAIEl = document.getElementById("settingsGroupAI");
    const phoneSettingsOverlayEnableAILabelEl = document.getElementById("settingsOverlayEnableAILabel");
    const phoneSettingsOverlayEnableAIEl = document.getElementById("settingsOverlayEnableAI");

    const phoneSettingsGroupCaptureEl = document.getElementById("settingsGroupCapture");
    const phoneSettingsCaptureWideLabelEl = document.getElementById("settingsCaptureWideLabel");
    const phoneSettingsCaptureWideEl = document.getElementById("settingsCaptureWide");
    const phoneSettingsSaveWideLabelEl = document.getElementById("settingsSaveWideLabel");
    const phoneSettingsSaveWideEl = document.getElementById("settingsSaveWide");
    const phoneSettingsCaptureUltraLabelEl = document.getElementById("settingsCaptureUltraLabel");
    const phoneSettingsCaptureUltraEl = document.getElementById("settingsCaptureUltra");
    const phoneSettingsSaveUltraLabelEl = document.getElementById("settingsSaveUltraLabel");
    const phoneSettingsSaveUltraEl = document.getElementById("settingsSaveUltra");

    const phoneSettingsGroupYouTubeEl = document.getElementById("settingsGroupYouTube");
    const phoneSettingsYouTubeStreamLabelEl = document.getElementById("settingsYouTubeStreamLabel");
    const phoneSettingsYouTubeStreamEl = document.getElementById("settingsYouTubeStream");

    const phoneSettingsGroupTwitchEl = document.getElementById("settingsGroupTwitch");
    const phoneSettingsTwitchStreamLabelEl = document.getElementById("settingsTwitchStreamLabel");
    const phoneSettingsTwitchStreamEl = document.getElementById("settingsTwitchStream");

    const phoneSettingsGroupWebRtcEl = document.getElementById("settingsGroupWebRtc");
    const phoneSettingsDailyStreamWideLabelEl = document.getElementById("settingsDailyStreamWideLabel");
    const phoneSettingsDailyStreamUltraLabelEl = document.getElementById("settingsDailyStreamUltraLabel");
    const phoneSettingsGameControllerLabelEl = document.getElementById("settingsGameControllerLabel");
    const phoneSettingsDailyStreamWideEl = document.getElementById("settingsDailyStreamWide");
    const phoneSettingsDailyStreamUltraEl = document.getElementById("settingsDailyStreamUltra");
    const phoneSettingsGameControllerEl = document.getElementById("settingsGameController");

    const phoneSettingsGroupRecordingStorageEl = document.getElementById("settingsGroupRecordingStorage");
    const phoneSettingsInternalStorageLabelEl = document.getElementById("settingsInternalStorageLabel");
    const phoneSettingsExternalStorageLabelEl = document.getElementById("settingsExternalStorageLabel");
    const phoneSettingsCloudStorageLabelEl = document.getElementById("settingsCloudStorageLabel");
    const phoneSettingsInternalStorageEl = document.getElementById("settingsInternalStorage");
    const phoneSettingsExternalStorageEl = document.getElementById("settingsExternalStorage");
    const phoneSettingsCloudStorageEl = document.getElementById("settingsCloudStorage");




    // Daily api handle
    var call = null;
    // Vis wide/ultra fra første remote, der har disse spor
    let targetSessionId = null;

    // Gamepad changes are sent to Daily as messages
    const onGamePadChange_debug = false;
    function onGamePadDataChange() {
      while(0 < gamePadData_changes.length) {
        const gamePadDataChange = gamePadData_changes.shift();
        if (onGamePadChange_debug) console.log("onGamePadDataChange: update#" + gamePadDataChange.update_index + ", changes=" + JSON.stringify(gamePadDataChange));
        if (call) call.sendAppMessage(gamePadDataChange, '*');
      }
    };
    gamePadData_changesCallback = onGamePadDataChange;

    var phoneSettingsData = {};
    
    var phoneMetricsData = [];
    function phoneMetricsDataClear() {
      delete phoneMetricsData;
      phoneMetricsData = [];
    };
    function phoneMetricsDataAdd(data, indexOfLast) {
      for(var i = 0; i < data.length; i++) {
        var entry = data[i];
        if (indexOfLast !== undefined && indexOfLast == entry.index) 
          break;
        phoneMetricsData.push(entry);
      }
    };
    phoneMetricsDataClear();

    var phoneMetricsDataAll = {};
    var phoneMetricsDataAllParentsArray = [];
    function phoneMetricsDataAllClear() {

      if (phoneMetricsDataAll) {
        if (phoneMetricsDataAll.fpsWide && phoneMetricsDataAll.fpsWide.data) 
          delete phoneMetricsDataAll.fpsWide.data;
        if (phoneMetricsDataAll.fpsUltra && phoneMetricsDataAll.fpsUltra.data) 
          delete phoneMetricsDataAll.fpsUltra.data;
        if (phoneMetricsDataAll.thermalState && phoneMetricsDataAll.thermalState.data) 
          delete phoneMetricsDataAll.thermalState.data;
        if (phoneMetricsDataAll.batteryPercentage && phoneMetricsDataAll.batteryPercentage.data) 
          delete phoneMetricsDataAll.batteryPercentage.data;
        if (phoneMetricsDataAll.dockkitBatteryPercentage && phoneMetricsDataAll.dockkitBatteryPercentage.data) 
          delete phoneMetricsDataAll.dockkitBatteryPercentage.data;
        if (phoneMetricsDataAll.pitchDegrees && phoneMetricsDataAll.pitchDegrees.data) 
          delete phoneMetricsDataAll.pitchDegrees.data;
        if (phoneMetricsDataAll.yawDegrees && phoneMetricsDataAll.yawDegrees.data) 
          delete phoneMetricsDataAll.yawDegrees.data;
        if (phoneMetricsDataAll.rollDegrees && phoneMetricsDataAll.rollDegrees.data) 
          delete phoneMetricsDataAll.rollDegrees.data;
        if (phoneMetricsDataAll.pitchDegreesPerSecs && phoneMetricsDataAll.pitchDegreesPerSecs.data) 
          delete phoneMetricsDataAll.pitchDegreesPerSecs.data;
        if (phoneMetricsDataAll.yawDegreesPerSecs && phoneMetricsDataAll.yawDegreesPerSecs.data) 
          delete phoneMetricsDataAll.yawDegreesPerSecs.data;
        if (phoneMetricsDataAll.rollDegreesPerSecs && phoneMetricsDataAll.rollDegreesPerSecs.data) 
          delete phoneMetricsDataAll.rollDegreesPerSecs.data;
        if (phoneMetricsDataAll.zoomFactorWide && phoneMetricsDataAll.zoomFactorWide.data) 
          delete phoneMetricsDataAll.zoomFactorWide.data;
      }

      phoneMetricsDataAll = {
        'fpsWide' : {
          'enabled' : true,
          'data' : []
        },
        'fpsUltra' : {
          'enabled' : true,
          'data' : []
        },
        'thermalState' : {
          'enabled' : true,
          'data' : []
        },
        'batteryPercentage' : {
          'enabled' : true,
          'data' : []
        },
        'dockkitBatteryPercentage' : {
          'enabled' : true,
          'data' : []
        },
        'pitchDegrees' : {
          'enabled' : true,
          'data' : []
        },
        'yawDegrees' : {
          'enabled' : true,
          'data' : []
        },
        'rollDegrees' : {
          'enabled' : true,
          'data' : []
        },
        'pitchDegreesPerSecs' : {
          'enabled' : true,
          'data' : []
        },
        'yawDegreesPerSecs' : {
          'enabled' : true,
          'data' : []
        },
        'rollDegreesPerSecs' : {
          'enabled' : true,
          'data' : []
        },
        'zoomFactorWide' : {
          'enabled' : true,
          'data' : []
        }
      };
      phoneMetricsDataAllParentsArray = [
        phoneMetricsDataAll.fpsWide,
        phoneMetricsDataAll.fpsUltra,
        phoneMetricsDataAll.thermalState,
        phoneMetricsDataAll.batteryPercentage,
        phoneMetricsDataAll.dockkitBatteryPercentage,
        phoneMetricsDataAll.pitchDegrees,
        phoneMetricsDataAll.yawDegrees,
        phoneMetricsDataAll.rollDegrees,
        phoneMetricsDataAll.pitchDegreesPerSecs,
        phoneMetricsDataAll.yawDegreesPerSecs,
        phoneMetricsDataAll.rollDegreesPerSecs,
        phoneMetricsDataAll.zoomFactorWide
      ];
    };
    phoneMetricsDataAllClear();
    var phoneMetricsDataAllIndexOfLast = 0;

    // Assign the specification to a local variable vlSpec.
    var vegaLiteMetricsChartObject = {
      "$schema": 'https://vega.github.io/schema/vega-lite/v6.json',
      "data": {
        "values": phoneMetricsData
      },
      "mark": {
        "type": "line",
        "point": true
      },
      "encoding": {
        "x": { "field": 'time', "type": 'temporal'},
        "y": {"field": 'value', "type": 'quantitative'},
        "color": {"field": "metric", "type": "nominal"}
      },
      "layer": [{
          "mark": "line"
        }, {
          "params": [{
              "name": "hover",
              "select": {"type": "point", "on": "pointerover", "clear": "pointerout"}
            }],
          "mark": {"type": "circle", "tooltip": true},
          "encoding": {
            "opacity": {
              "condition": {"test": {"param": "hover", "empty": false}, "value": 1},
              "value": 0
            },
            "size": {
              "condition": {"test": {"param": "hover", "empty": false}, "value": 48},
              "value": 100
            }
          }
        }]
    };
    var vegaLiteListeners = [];
    var vegaLiteReturnObject = null;
    const orig = EventTarget.prototype.addEventListener;
    EventTarget.prototype.addEventListener = function(...args) {
      if (this instanceof HTMLElement) {
        //console.log('this=' + this + ', args=' + args)
        vegaLiteListeners.push({
          type: args[0],
          fn: args[1],
          target: this,
        });
      }
      return orig.apply(this, args);
    };


    
    function updatePhoneSettingsUI() {

      // Read settings

      let isPhoneConnected = (targetSessionId !== null);

      let hasPhoneSettingsVersion = isPhoneConnected && "version" in phoneSettingsData && phoneSettingsData.version;
      let phoneSettingsVersion = hasPhoneSettingsVersion ? phoneSettingsData.version : "<?>";

      let isCustomerBuildEnabled = isPhoneConnected && "customerBuild" in phoneSettingsData && phoneSettingsData.customerBuild;

      let isOverlayEnableAIEnabled = isPhoneConnected && "overlayEnableAI" in phoneSettingsData && phoneSettingsData.overlayEnableAI;

      let isCaptureWideEnabled = isPhoneConnected && "captureWide" in phoneSettingsData && phoneSettingsData.captureWide;
      let isSaveWideEnabled = isPhoneConnected && "saveWide" in phoneSettingsData && phoneSettingsData.saveWide;
      let isCaptureUltraEnabled = isPhoneConnected && "captureUltra" in phoneSettingsData && phoneSettingsData.captureUltra;
      let isSaveUltraEnabled = isPhoneConnected && "saveUltra" in phoneSettingsData && phoneSettingsData.saveUltra;

      let isYouTubeStreamEnabled = isPhoneConnected && "YouTubeStream" in phoneSettingsData && phoneSettingsData.YouTubeStream;
      let YouTubeStreamKeyIsValid = isPhoneConnected && "YouTubeStreamKeyIsValid" in phoneSettingsData && phoneSettingsData.YouTubeStreamKeyIsValid;

      let isTwitchStreamEnabled = isPhoneConnected && "TwitchStream" in phoneSettingsData && phoneSettingsData.TwitchStream;
      let TwitchStreamKeyIsValid = isPhoneConnected && "TwitchStreamKeyIsValid" in phoneSettingsData && phoneSettingsData.TwitchStreamKeyIsValid;

      let isDailyStreamWideEnabled = isPhoneConnected && "DailyStreamWide" in phoneSettingsData && phoneSettingsData.DailyStreamWide;
      let isDailyStreamUltraEnabled = isPhoneConnected && "DailyStreamUltra" in phoneSettingsData && phoneSettingsData.DailyStreamUltra;
      let isGameControllerEnabled = isPhoneConnected && "gameController" in phoneSettingsData && phoneSettingsData.gameController;

      let isInternalStorageEnabled = isPhoneConnected && "storageLocation" in phoneSettingsData && "internalStorage" == phoneSettingsData.storageLocation;
      let isExternalStorageEnabled = isPhoneConnected && "storageLocation" in phoneSettingsData && "externalStorage" == phoneSettingsData.storageLocation;
      let isCloudStorageEnabled = isPhoneConnected && "storageLocation" in phoneSettingsData && "cloudStorage" == phoneSettingsData.storageLocation;

      // Update text and controls

      if (isPhoneConnected) 
        phoneStatusEl.textContent = "Phone: Connected ✓";
      else
        phoneStatusEl.textContent = "Phone: Disconnected"

      phoneSettingsVersionEl.textContent = "Settings Version: " + phoneSettingsVersion;

      phoneSettingsCustomerBuildEl.disabled = !(isPhoneConnected);
      let phoneSettingsCustomerBuildCheckedWas = phoneSettingsCustomerBuildEl.checked;
      phoneSettingsCustomerBuildEl.checked = isCustomerBuildEnabled;
      
      phoneSettingsOverlayEnableAIEl.disabled = !(isPhoneConnected);
      let phoneSettingsOverlayEnableAICheckedWas = phoneSettingsOverlayEnableAIEl.checked;
      phoneSettingsOverlayEnableAIEl.checked = isOverlayEnableAIEnabled;
      
      phoneSettingsCaptureWideEl.disabled = !(isPhoneConnected);
      let phoneSettingsCaptureWideCheckedWas = phoneSettingsCaptureWideEl.checked;
      phoneSettingsCaptureWideEl.checked = isCaptureWideEnabled;
      phoneSettingsSaveWideEl.disabled = !(isPhoneConnected);
      let phoneSettingsSaveWideCheckedWas = phoneSettingsSaveWideEl.checked;
      phoneSettingsSaveWideEl.checked = isSaveWideEnabled;
      phoneSettingsCaptureUltraEl.disabled = !(isPhoneConnected);
      let phoneSettingsCaptureUltraCheckedWas = phoneSettingsCaptureUltraEl.checked;
      phoneSettingsCaptureUltraEl.checked = isCaptureUltraEnabled;
      phoneSettingsSaveUltraEl.disabled = !(isPhoneConnected);
      let phoneSettingsSaveUltraCheckedWas = phoneSettingsSaveUltraEl.checked;
      phoneSettingsSaveUltraEl.checked = isSaveUltraEnabled;

      phoneSettingsYouTubeStreamEl.disabled = !(isPhoneConnected && isCaptureWideEnabled && YouTubeStreamKeyIsValid);
      let phoneSettingsYouTubeStreamCheckedWas = phoneSettingsYouTubeStreamEl.checked;
      phoneSettingsYouTubeStreamEl.checked = isYouTubeStreamEnabled;

      phoneSettingsTwitchStreamEl.disabled = !(isPhoneConnected && isCaptureWideEnabled && TwitchStreamKeyIsValid);
      let phoneSettingsTwitchStreamCheckedWas = phoneSettingsTwitchStreamEl.checked;
      phoneSettingsTwitchStreamEl.checked = isTwitchStreamEnabled;

      phoneSettingsDailyStreamWideEl.disabled = !(isPhoneConnected && isCaptureWideEnabled);
      let phoneSettingsDailyStreamWideCheckedWas = phoneSettingsDailyStreamWideEl.checked;
      phoneSettingsDailyStreamWideEl.checked = isDailyStreamWideEnabled;
      phoneSettingsDailyStreamUltraEl.disabled = !(isPhoneConnected && isCaptureUltraEnabled);
      let phoneSettingsDailyStreamUltraCheckedWas = phoneSettingsDailyStreamUltraEl.checked;
      phoneSettingsDailyStreamUltraEl.checked = isDailyStreamUltraEnabled;
      phoneSettingsGameControllerEl.disabled = !(isPhoneConnected);
      let phoneSettingsGameControllerCheckedWas = phoneSettingsGameControllerEl.checked;
      phoneSettingsGameControllerEl.checked = isGameControllerEnabled;

      phoneSettingsInternalStorageEl.disabled = !(isPhoneConnected);
      let phoneSettingsInternalStorageCheckedWas = phoneSettingsInternalStorageEl.checked;
      phoneSettingsInternalStorageEl.checked = isInternalStorageEnabled;
      phoneSettingsExternalStorageEl.disabled = !(isPhoneConnected);
      let phoneSettingsExternalStorageCheckedWas = phoneSettingsExternalStorageEl.checked;
      phoneSettingsExternalStorageEl.checked = isExternalStorageEnabled;
      phoneSettingsCloudStorageEl.disabled = !(isPhoneConnected);
      let phoneSettingsCloudStorageCheckedWas = phoneSettingsCloudStorageEl.checked;
      phoneSettingsCloudStorageEl.checked = isCloudStorageEnabled;

      // Logically Toggles groups - any On event will expand a group, any Off event can collapse the group if non are On 

      if (phoneSettingsGroupAppEl.checked) {
        if (phoneSettingsCustomerBuildCheckedWas && !phoneSettingsCustomerBuildEl.checked)
          phoneSettingsGroupAppEl.checked = false;
      } else {
        if (!phoneSettingsCustomerBuildCheckedWas && phoneSettingsCustomerBuildEl.checked)
          phoneSettingsGroupAppEl.checked = true;
      }

      if (phoneSettingsGroupAIEl.checked) {
        if (phoneSettingsOverlayEnableAICheckedWas && !phoneSettingsOverlayEnableAIEl.checked)
          phoneSettingsGroupAIEl.checked = false;
      } else {
        if (!phoneSettingsOverlayEnableAICheckedWas && phoneSettingsOverlayEnableAIEl.checked)
          phoneSettingsGroupAIEl.checked = true;
      }

      if (phoneSettingsGroupCaptureEl.checked) {
        if ((phoneSettingsCaptureWideCheckedWas && !phoneSettingsCaptureWideEl.checked)
          || (phoneSettingsSaveWideCheckedWas && !phoneSettingsSaveWideEl.checked)
          || (phoneSettingsCaptureUltraCheckedWas && !phoneSettingsCaptureUltraEl.checked)
          || (phoneSettingsSaveUltraCheckedWas && !phoneSettingsSaveUltraEl.checked))
          phoneSettingsGroupCaptureEl.checked = phoneSettingsCaptureWideEl.checked || phoneSettingsSaveWideEl.checked || phoneSettingsCaptureUltraEl.checked || phoneSettingsSaveUltraEl.checked;
      } else {
        if ((!phoneSettingsCaptureWideCheckedWas && phoneSettingsCaptureWideEl.checked)
          || (!phoneSettingsSaveWideCheckedWas && phoneSettingsSaveWideEl.checked)
          || (!phoneSettingsCaptureUltraCheckedWas && phoneSettingsCaptureUltraEl.checked)
          || (!phoneSettingsSaveUltraCheckedWas && phoneSettingsSaveUltraEl.checked))
          phoneSettingsGroupCaptureEl.checked = true;
      }

      if (phoneSettingsGroupYouTubeEl.checked) {
        if (phoneSettingsYouTubeStreamCheckedWas && !phoneSettingsYouTubeStreamEl.checked)
          phoneSettingsGroupYouTubeEl.checked = false;
      } else {
        if (!phoneSettingsYouTubeStreamCheckedWas && phoneSettingsYouTubeStreamEl.checked)
          phoneSettingsGroupYouTubeEl.checked = true;
      }

      if (phoneSettingsGroupTwitchEl.checked) {
        if (phoneSettingsTwitchStreamCheckedWas && !phoneSettingsTwitchStreamEl.checked)
          phoneSettingsGroupTwitchEl.checked = false;
      } else {
        if (!phoneSettingsTwitchStreamCheckedWas && phoneSettingsTwitchStreamEl.checked)
          phoneSettingsGroupTwitchEl.checked = true;
      }

      if (phoneSettingsGroupWebRtcEl.checked) {
        if ((phoneSettingsDailyStreamWideCheckedWas && !phoneSettingsDailyStreamWideEl.checked)
          || (phoneSettingsDailyStreamUltraCheckedWas && !phoneSettingsDailyStreamUltraEl.checked)
          || (phoneSettingsGameControllerCheckedWas && !phoneSettingsGameControllerEl.checked))
          phoneSettingsGroupWebRtcEl.checked = phoneSettingsDailyStreamWideEl.checked || phoneSettingsDailyStreamUltraEl.checked || phoneSettingsGameControllerEl.checked;
      } else {
        if ((!phoneSettingsDailyStreamWideCheckedWas && phoneSettingsDailyStreamWideEl.checked)
          || (!phoneSettingsDailyStreamUltraCheckedWas && phoneSettingsDailyStreamUltraEl.checked)
          || (!phoneSettingsGameControllerCheckedWas && phoneSettingsGameControllerEl.checked))
          phoneSettingsGroupWebRtcEl.checked = true;
      }

      if (phoneSettingsGroupRecordingStorageEl.checked) {
        if ((phoneSettingsInternalStorageCheckedWas && !phoneSettingsInternalStorageEl.checked)
          || (phoneSettingsExternalStorageCheckedWas && !phoneSettingsExternalStorageEl.checked)
          || (phoneSettingsCloudStorageCheckedWas && !phoneSettingsCloudStorageEl.checked))
          phoneSettingsGroupRecordingStorageEl.checked = phoneSettingsInternalStorageEl.checked || phoneSettingsExternalStorageEl.checked || phoneSettingsCloudStorageEl.checked;
      } else {
        if ((!phoneSettingsInternalStorageCheckedWas && phoneSettingsInternalStorageEl.checked)
          || (!phoneSettingsExternalStorageCheckedWas && phoneSettingsExternalStorageEl.checked)
          || (!phoneSettingsCloudStorageCheckedWas && phoneSettingsCloudStorageEl.checked))
          phoneSettingsGroupRecordingStorageEl.checked = true;
      }


      // Visually Toggles groups

      let displayValApp = phoneSettingsGroupAppEl.checked ? 'inline-block' : 'none';
      phoneSettingsCustomerBuildLabelEl.style.display = displayValApp;

      let displayValAI = phoneSettingsGroupAIEl.checked ? 'inline-block' : 'none';
      phoneSettingsOverlayEnableAILabelEl.style.display = displayValAI;

      let displayValCapture = phoneSettingsGroupCaptureEl.checked ? 'inline-block' : 'none';
      phoneSettingsCaptureWideLabelEl.style.display = displayValCapture;
      phoneSettingsSaveWideLabelEl.style.display = displayValCapture;
      phoneSettingsCaptureUltraLabelEl.style.display = displayValCapture;
      phoneSettingsSaveUltraLabelEl.style.display = displayValCapture;

      let displayValYouTube = phoneSettingsGroupYouTubeEl.checked ? 'inline-block' : 'none';
      phoneSettingsYouTubeStreamLabelEl.style.display = displayValYouTube;

      let displayValTwitch = phoneSettingsGroupTwitchEl.checked ? 'inline-block' : 'none';
      phoneSettingsTwitchStreamLabelEl.style.display = displayValTwitch;

      let displayValWebRtc = phoneSettingsGroupWebRtcEl.checked ? 'inline-block' : 'none';
      phoneSettingsDailyStreamWideLabelEl.style.display = displayValWebRtc;
      phoneSettingsDailyStreamUltraLabelEl.style.display = displayValWebRtc;
      phoneSettingsGameControllerLabelEl.style.display = displayValWebRtc;      

      let displayValRecordingStorage = phoneSettingsGroupRecordingStorageEl.checked ? 'inline-block' : 'none';
      phoneSettingsInternalStorageLabelEl.style.display = displayValRecordingStorage;
      phoneSettingsExternalStorageLabelEl.style.display = displayValRecordingStorage;
      phoneSettingsCloudStorageLabelEl.style.display = displayValRecordingStorage;
    }
    async function updatePhoneMetricsUI(forceUpdate) {

      // Clear data used by graph and rebuild it

      if (forceUpdate) {
        phoneMetricsDataClear();

        if (phoneMetricsDataAll.fpsWide.enabled) {
          phoneMetricsDataAdd(phoneMetricsDataAll.fpsWide.data, phoneMetricsDataAllIndexOfLast);
        }
        if (phoneMetricsDataAll.fpsUltra.enabled) {
          phoneMetricsDataAdd(phoneMetricsDataAll.fpsUltra.data, phoneMetricsDataAllIndexOfLast);
        }

        if (phoneMetricsDataAll.thermalState.enabled) {
          phoneMetricsDataAdd(phoneMetricsDataAll.thermalState.data, phoneMetricsDataAllIndexOfLast);
        }

        if (phoneMetricsDataAll.batteryPercentage.enabled) {
          phoneMetricsDataAdd(phoneMetricsDataAll.batteryPercentage.data, phoneMetricsDataAllIndexOfLast);
        }

        if (phoneMetricsDataAll.dockkitBatteryPercentage.enabled) {
          phoneMetricsDataAdd(phoneMetricsDataAll.dockkitBatteryPercentage.data, phoneMetricsDataAllIndexOfLast);
        }

        if (phoneMetricsDataAll.pitchDegrees.enabled) {
          phoneMetricsDataAdd(phoneMetricsDataAll.pitchDegrees.data, phoneMetricsDataAllIndexOfLast);
        }
        if (phoneMetricsDataAll.yawDegrees.enabled) {
          phoneMetricsDataAdd(phoneMetricsDataAll.yawDegrees.data, phoneMetricsDataAllIndexOfLast);
        }
        if (phoneMetricsDataAll.rollDegrees.enabled) {
          phoneMetricsDataAdd(phoneMetricsDataAll.rollDegrees.data, phoneMetricsDataAllIndexOfLast);
        }

        if (phoneMetricsDataAll.pitchDegreesPerSecs.enabled) {
          phoneMetricsDataAdd(phoneMetricsDataAll.pitchDegreesPerSecs.data, phoneMetricsDataAllIndexOfLast);
        }
        if (phoneMetricsDataAll.yawDegreesPerSecs.enabled) {
          phoneMetricsDataAdd(phoneMetricsDataAll.yawDegreesPerSecs.data, phoneMetricsDataAllIndexOfLast);
        }
        if (phoneMetricsDataAll.rollDegreesPerSecs.enabled) {
          phoneMetricsDataAdd(phoneMetricsDataAll.rollDegreesPerSecs.data, phoneMetricsDataAllIndexOfLast);
        }

        if (phoneMetricsDataAll.zoomFactorWide.enabled) {
          phoneMetricsDataAdd(phoneMetricsDataAll.zoomFactorWide.data, phoneMetricsDataAllIndexOfLast);
        }
      }

      let displayValPlot = phoneMetricsGroupPlotEl.checked ? 'inline-block' : 'none';
      phoneMetricsTogglePlottingLabelEl.style.display = displayValPlot;
      phoneMetricsClearLabelEl.style.display = displayValPlot;

      let displayValSeries = phoneMetricsGroupSeriesEl.checked ? 'inline-block' : 'none';
      phoneMetricsToggleFpsWideLabelEl.style.display = displayValSeries;
      phoneMetricsToggleFpsUltraLabelEl.style.display = displayValSeries;
      phoneMetricsToggleThermalStateLabelEl.style.display = displayValSeries;
      phoneMetricsToggleBatteryPercentageLabelEl.style.display = displayValSeries;
      phoneMetricsToogleDockkitBatteryPercentageLabelEl.style.display = displayValSeries;
      phoneMetricsTogglePitchDegreesLabelEl.style.display = displayValSeries;
      phoneMetricsToggleYawDegreesLabelEl.style.display = displayValSeries;
      phoneMetricsToggleRollDegreesLabelEl.style.display = displayValSeries;
      phoneMetricsTogglePitchDegreesPerSecsLabelEl.style.display = displayValSeries;
      phoneMetricsToggleYawDegreesPerSecsLabelEl.style.display = displayValSeries;
      phoneMetricsToggleRollDegreesPerSecsLabelEl.style.display = displayValSeries;
      phoneMetricsToogleZoomFactorWideLabelEl.style.display = displayValSeries;

      phoneMetricsToggleFpsWideEl.checked = phoneMetricsDataAll.fpsWide.enabled;
      phoneMetricsToggleFpsUltraEl.checked = phoneMetricsDataAll.fpsUltra.enabled;
      phoneMetricsToggleThermalStateEl.checked = phoneMetricsDataAll.thermalState.enabled;
      phoneMetricsToggleBatteryPercentageEl.checked = phoneMetricsDataAll.batteryPercentage.enabled;
      phoneMetricsToggleDockkitBatteryPercentageEl.checked = phoneMetricsDataAll.dockkitBatteryPercentage.enabled;
      phoneMetricsTogglePitchDegreesEl.checked = phoneMetricsDataAll.pitchDegrees.enabled;
      phoneMetricsToggleYawDegreesEl.checked = phoneMetricsDataAll.yawDegrees.enabled;
      phoneMetricsToggleRollDegreesEl.checked = phoneMetricsDataAll.rollDegrees.enabled;
      phoneMetricsTogglePitchDegreesPerSecsEl.checked = phoneMetricsDataAll.pitchDegreesPerSecs.enabled;
      phoneMetricsToggleYawDegreesPerSecsEl.checked = phoneMetricsDataAll.yawDegreesPerSecs.enabled;
      phoneMetricsToggleRollDegreesPerSecsEl.checked = phoneMetricsDataAll.rollDegreesPerSecs.enabled;
      phoneMetricsToggleZoomFactorWideEl.checked = phoneMetricsDataAll.zoomFactorWide.enabled;

      if(phoneMetricsTogglePlottingEl.checked || forceUpdate) {

        if (vegaLiteMetricsChartObject && vegaLiteMetricsChartObject.data && vegaLiteMetricsChartObject.data.values) {
          delete vegaLiteMetricsChartObject.data.values;
          vegaLiteMetricsChartObject.data.values = phoneMetricsData;
        }

        // Delete vega lite elements
        var placeholder = document.getElementById('phone-metrics-placeholder');
        while (placeholder && placeholder.firstChild) {
          placeholder.removeChild(placeholder.lastChild);
        }
        // Cleanup leaked vega lite event handlers
//        console.log("updatePhoneMetricsUI: cleaning up " + vegaLiteListeners.length + " event listeners.");
        while (0 < vegaLiteListeners.length) {
          var listener = vegaLiteListeners.pop();
          document.removeEventListener(listener.type, listener.fn);
        }

        // Clean vega lite ref object
        if (vegaLiteReturnObject) {
          vegaLiteReturnObject.finalize();
          vegaLiteReturnObject = null;
        }
        // Embed the visualization in the container with id `vis`
//        console.log("updatePhoneMetricsUI: before ");
        vegaEmbed('#phone-metrics-placeholder', vegaLiteMetricsChartObject).then(r => {
//          console.log("updatePhoneMetricsUI: after r=" + r);
          vegaLiteReturnObject = r;
        });
      }

    }

    updatePhoneSettingsUI();
    phoneMetricsGroupPlotEl.checked = true;
    phoneMetricsTogglePlottingEl.checked = true;
    phoneMetricsClear.checked = false;
    updatePhoneMetricsUI(true);

    if (!roomName) {
      browserStatusEl.textContent = "Browser: Error! no room name (?name=…)";
      throw new Error("Missing ?name param");
    }
    const roomUrl = `https://veo-labs.daily.co/${encodeURIComponent(roomName)}`;

    // Minimal call-objekt (ingen iframe)
    call = window.DailyIframe.createCallObject({
      subscribeToTracksAutomatically: true
    });

    const attached = { vWide: null, vUltra: null };

    function attachTrack(el, placeholder, mediaTrack) {
      if (!mediaTrack) return;
      if (attached[el.id] === mediaTrack.id) return;
      attached[el.id] = mediaTrack.id;
      el.srcObject = new MediaStream([mediaTrack]);
      placeholder.classList.add("hidden");
      const tryPlay = () => el.play().catch(()=>{});
      if (el.readyState >= 1) tryPlay(); else el.onloadedmetadata = tryPlay;
    }

    function detach(el, placeholder) {
      el.srcObject = null;
      attached[el.id] = null;
      placeholder.classList.remove("hidden");
    }
    function detachAll() {
      detach(vWide, phWide);
      detach(vUltra, phUltra);
    }

    function maybeAttachFor(p) {
      if (!p || p.local) return;

      if (!targetSessionId) { // && (p.tracks?.wide || p.tracks?.ultraWide)) {
        targetSessionId = p.session_id;
        console.log("maybeAttachFor: starting session [targetSessionId=" + targetSessionId + "]");
      }
      if (p.session_id !== targetSessionId) return;

      const wide  = p.tracks?.wide;
      const ultra = p.tracks?.ultraWide;

      const wideTrack  = wide?.persistentTrack  || wide?.track;
      const ultraTrack = ultra?.persistentTrack || ultra?.track;

      if (wide?.state === "playable" && wideTrack)  attachTrack(vWide,  phWide,  wideTrack);
      else detach(vWide, phWide);

      if (ultra?.state === "playable" && ultraTrack) attachTrack(vUltra, phUltra, ultraTrack);
      else detach(vUltra, phUltra);

    }

    function dataArrayOptimizeByRemovingIntermediateDuplicates(a_p, epsilon, debug) {
      var trimmed_count = 0;
      if (2 < a_p.data.length) {
        var before_index = -1;
        var current_index = 0;
        var after_index = 1;
        var remove_current = false;

        while(after_index < a_p.data.length) {
          remove_current = false;
          
          if (0 <= before_index && after_index < a_p.data.length) {
            var before_val = a_p.data[before_index].value;
            var current_val = a_p.data[current_index].value;
            var after_val = a_p.data[after_index].value;
            var diff_before_after = Math.abs(before_val - after_val);
            var diff_before_current = Math.abs(before_val - current_val);
            if(diff_before_after < epsilon && diff_before_current < epsilon) {
              remove_current = true;
            }
          }

          if(remove_current) {
            a_p.data.splice(current_index, 1);
            trimmed_count++;
          } else {
            before_index++;
            current_index++;
            after_index++;
          }

        }
      }

      if (debug && 0 < trimmed_count)
        console.log("dataArrayOptimizeByRemovingIntermediateDuplicates: epsilon=" + epsilon + ", trimmed_count=" + trimmed_count);
    }

    function dataArrayOptimizeByDiscardingHalf(maxLength, a_p, debug) {
      var a_n = [];
      var start_index = 0;
      if (0 < a_p.data.length % 2) {
        // uneven => skip 1st to get last
        start_index = 1;
      }

      var half_length = a_p.data.length/2;
      for(var a_j = start_index; a_j <= half_length; ++a_j) {
        a_n.push(a_p.data[2*a_j]); 
      }

      if (debug) 
        console.log("dataArrayOptimizeByDiscardingHalf: a_p.data.length=" + a_p.data.length + ", start_index=" + start_index + ", half_length=" + half_length + ", a_n.length=" + a_n.length);

      return a_n;
    }

    function phoneMetricsDataAllOptimize() {
      const phoneMetricsDataAllOptimize_debug = false;
      const maxLength = 120;
      const epsilon = 0.001;

      for(var a_p_i = 0; a_p_i < phoneMetricsDataAllParentsArray.length; ++a_p_i) {
        var a_p = phoneMetricsDataAllParentsArray[a_p_i];
        // Method#1
        if (maxLength < a_p.data.length) {
          var length_before = a_p.data.length;
          dataArrayOptimizeByRemovingIntermediateDuplicates(a_p, epsilon, phoneMetricsDataAllOptimize_debug);
          var length_after = a_p.data.length;
          if(phoneMetricsDataAllOptimize_debug && length_after < length_before)
            console.log("phoneMetricsDataAllOptimize: datetime= " + (new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })) + ", a_p_i#" + a_p_i + ", length_before=" + length_before + ", length_after=" + length_after + ", epsilon=" + epsilon + " => " + (length_before - length_after) + " duplicates");
        }

        // Method#2
        if (maxLength < a_p.data.length) {
          var length_before = a_p.data.length;
          var a_n = dataArrayOptimizeByDiscardingHalf(maxLength, a_p, phoneMetricsDataAllOptimize_debug);
          var length_after = a_n;
          if(phoneMetricsDataAllOptimize_debug && length_after < length_before)
            console.log("phoneMetricsDataAllOptimize: datetime= " + (new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })) + ", a_p_i#" + a_p_i + ", length_before=" + length_before + ", length_after=" + length_after + " => " + (length_before - length_after) + " discarded");
          delete a_p.data;
          a_p.data = a_n;
        }

        //if(a_p_i == 1) 
        //  console.log("a_p_i#" + a_p_i + ", a_p.data.length=" + a_p.data.length);
      }
    }

    function handleAppMessage(ev) {
        //console.log("handleAppMessage: ev=" + ev)
        if (ev && ev.data) {
          if (ev.data.kind && ev.data.kind == 'Metrics') {
            var entry1 = {
              'index': ev.data.index,
              'time': new Date(ev.data.time_utc),
              'value': ev.data.fpsWide !== undefined ? ev.data.fpsWide : null,
              'metric': 'fpsWide [frames/sec]',
            };
            var entry2 = {
              'index': ev.data.index,
              'time': new Date(ev.data.time_utc),
              'value': ev.data.fpsUltra !== undefined ? ev.data.fpsUltra : null,
              'metric': 'fpsUltra [frames/sec]',
            };
            var entry3 = {
              'index': ev.data.index,
              'time': new Date(ev.data.time_utc),
              'value': ev.data.thermalState !== undefined ? ev.data.thermalState : null,
              'metric': 'thermalState [25*(state+1)]',
            };
            var entry4 = {
              'index': ev.data.index,
              'time': new Date(ev.data.time_utc),
              'value': ev.data.batteryPercentage !== undefined ? ev.data.batteryPercentage : null,
              'metric': 'battery [%]',
            };
            var entry5 = {
              'index': ev.data.index,
              'time': new Date(ev.data.time_utc),
              'value': ev.data.dockkitBatteryPercentage !== undefined ? ev.data.dockkitBatteryPercentage : null,
              'metric': 'dockkitBattery [%]',
            };
            var entry6 = {
              'index': ev.data.index,
              'time': new Date(ev.data.time_utc),
              'value': ev.data.pitchDegrees !== undefined ? ev.data.pitchDegrees : null,
              'metric': 'pitch [°]',
            };
            var entry7 = {
              'index': ev.data.index,
              'time': new Date(ev.data.time_utc),
              'value': ev.data.yawDegrees !== undefined ? ev.data.yawDegrees : null,
              'metric': 'yaw [°]',
            };
            var entry8 = {
              'index': ev.data.index,
              'time': new Date(ev.data.time_utc),
              'value': ev.data.rollDegrees !== undefined ? ev.data.rollDegrees : null,
              'metric': 'roll [°]',
            };
            var entry9 = {
              'index': ev.data.index,
              'time': new Date(ev.data.time_utc),
              'value': ev.data.pitchDegreesPerSecs !== undefined ? ev.data.pitchDegreesPerSecs : null,
              'metric': 'pitch vel. [°/s]',
            };
            var entry10 = {
              'index': ev.data.index,
              'time': new Date(ev.data.time_utc),
              'value': ev.data.yawDegreesPerSecs !== undefined ? ev.data.yawDegreesPerSecs : null,
              'metric': 'yaw vel. [°/s]',
            };
            var entry11 = {
              'index': ev.data.index,
              'time': new Date(ev.data.time_utc),
              'value': ev.data.rollDegreesPerSecs !== undefined ? ev.data.rollDegreesPerSecs : null,
              'metric': 'roll vel. [°/s]',
            };
            var entry12 = {
              'index': ev.data.index,
              'time': new Date(ev.data.time_utc),
              'value': ev.data.zoomFactorWide !== null ? 100.0*ev.data.zoomFactorWide : nil,
              'metric': 'zoomFactorWide [%]',
            };

            
            phoneMetricsDataAll.fpsWide.data.push(entry1);
            phoneMetricsDataAll.fpsUltra.data.push(entry2);
            phoneMetricsDataAll.thermalState.data.push(entry3);
            phoneMetricsDataAll.batteryPercentage.data.push(entry4);
            phoneMetricsDataAll.dockkitBatteryPercentage.data.push(entry5);
            phoneMetricsDataAll.pitchDegrees.data.push(entry6);
            phoneMetricsDataAll.yawDegrees.data.push(entry7);
            phoneMetricsDataAll.rollDegrees.data.push(entry8);
            phoneMetricsDataAll.pitchDegreesPerSecs.data.push(entry9);
            phoneMetricsDataAll.yawDegreesPerSecs.data.push(entry10);
            phoneMetricsDataAll.rollDegreesPerSecs.data.push(entry11);
            phoneMetricsDataAll.zoomFactorWide.data.push(entry12);

            if (phoneMetricsTogglePlottingEl.checked) {
              if (phoneMetricsDataAll.fpsWide.enabled) {
                phoneMetricsData.push(entry1);
              }
              if (phoneMetricsDataAll.fpsUltra.enabled) {
                phoneMetricsData.push(entry2);
              }
              if (phoneMetricsDataAll.thermalState.enabled) {
                phoneMetricsData.push(entry3);
              }
              if (phoneMetricsDataAll.batteryPercentage.enabled) {
                phoneMetricsData.push(entry4);
              }
              if (phoneMetricsDataAll.dockkitBatteryPercentage.enabled) {
                phoneMetricsData.push(entry5);
              }
              if (phoneMetricsDataAll.pitchDegrees.enabled) {
                phoneMetricsData.push(entry6);
              }
              if (phoneMetricsDataAll.yawDegrees.enabled) {
                phoneMetricsData.push(entry7);
              }
              if (phoneMetricsDataAll.rollDegrees.enabled) {
                phoneMetricsData.push(entry8);
              }
              if (phoneMetricsDataAll.pitchDegreesPerSecs.enabled) {
                phoneMetricsData.push(entry9);
              }
              if (phoneMetricsDataAll.yawDegreesPerSecs.enabled) {
                phoneMetricsData.push(entry10);
              }
              if (phoneMetricsDataAll.rollDegreesPerSecs.enabled) {
                phoneMetricsData.push(entry11);
              }
              if (phoneMetricsDataAll.zoomFactorWide.enabled) {
                phoneMetricsData.push(entry12);
              }
            }

            if(phoneMetricsTogglePlottingEl.checked)
              phoneMetricsDataAllIndexOfLast = ev.data.index;
            
            phoneMetricsClear.checked = true;
            phoneMetricsDataAllOptimize();
            updatePhoneMetricsUI();
          } else {
            phoneSettingsData = ev.data;

            updatePhoneSettingsUI();
          }
        }
    }
    function settingsWebUserGroupToggle(obj) {
      updatePhoneSettingsUI();
    }
    function settingsWebUserChangedProperty(obj) {
      switch(obj.id) {
        case phoneMetricsClear.id: phoneMetricsDataClear(); phoneMetricsDataAllClear(); obj.checked = false; updatePhoneMetricsUI(true); break;
        case phoneMetricsTogglePlottingEl.id: if (obj.checked) updatePhoneMetricsUI(true); break;
        case phoneMetricsToggleFpsWideEl.id: phoneMetricsDataAll.fpsWide.enabled = obj.checked; updatePhoneMetricsUI(true); break;
        case phoneMetricsToggleFpsUltraEl.id: phoneMetricsDataAll.fpsUltra.enabled = obj.checked; updatePhoneMetricsUI(true); break;
        case phoneMetricsToggleThermalStateEl.id: phoneMetricsDataAll.thermalState.enabled = obj.checked; updatePhoneMetricsUI(true); break;
        case phoneMetricsToggleBatteryPercentageEl.id: phoneMetricsDataAll.batteryPercentage.enabled = obj.checked; updatePhoneMetricsUI(true); break;
        case phoneMetricsToggleDockkitBatteryPercentageEl.id: phoneMetricsDataAll.dockkitBatteryPercentage.enabled = obj.checked; updatePhoneMetricsUI(true); break;
        case phoneMetricsTogglePitchDegreesEl.id: phoneMetricsDataAll.pitchDegrees.enabled = obj.checked; updatePhoneMetricsUI(true); break;
        case phoneMetricsToggleYawDegreesEl.id: phoneMetricsDataAll.yawDegrees.enabled = obj.checked; updatePhoneMetricsUI(true); break;
        case phoneMetricsToggleRollDegreesEl.id: phoneMetricsDataAll.rollDegrees.enabled = obj.checked; updatePhoneMetricsUI(true); break;
        case phoneMetricsTogglePitchDegreesPerSecsEl.id: phoneMetricsDataAll.pitchDegreesPerSecs.enabled = obj.checked; updatePhoneMetricsUI(true); break;
        case phoneMetricsToggleYawDegreesPerSecsEl.id: phoneMetricsDataAll.yawDegreesPerSecs.enabled = obj.checked; updatePhoneMetricsUI(true); break;
        case phoneMetricsToggleRollDegreesPerSecsEl.id: phoneMetricsDataAll.rollDegreesPerSecs.enabled = obj.checked; updatePhoneMetricsUI(true); break;
        case phoneMetricsToggleZoomFactorWideEl.id: phoneMetricsDataAll.zoomFactorWide.enabled = obj.checked; updatePhoneMetricsUI(true); break;

        case phoneSettingsCustomerBuildEl.id: phoneSettingsData.customerBuild = obj.checked; settingsDataSendToPhone(); break;

        case phoneSettingsOverlayEnableAIEl.id: phoneSettingsData.overlayEnableAI = obj.checked; settingsDataSendToPhone(); break;

        case phoneSettingsCaptureWideEl.id: phoneSettingsData.captureWide = obj.checked; settingsDataSendToPhone(); break;
        case phoneSettingsSaveWideEl.id: phoneSettingsData.saveWide = obj.checked; settingsDataSendToPhone(); break;
        case phoneSettingsCaptureUltraEl.id: phoneSettingsData.captureUltra = obj.checked; settingsDataSendToPhone(); break;
        case phoneSettingsSaveUltraEl.id: phoneSettingsData.saveUltra = obj.checked; settingsDataSendToPhone(); break;

        case phoneSettingsYouTubeStreamEl.id: phoneSettingsData.YouTubeStream = obj.checked; settingsDataSendToPhone(); break;

        case phoneSettingsTwitchStreamEl.id: phoneSettingsData.TwitchStream = obj.checked; settingsDataSendToPhone(); break;

        case phoneSettingsDailyStreamWideEl.id: phoneSettingsData.DailyStreamWide = obj.checked; settingsDataSendToPhone(); break;
        case phoneSettingsDailyStreamUltraEl.id: phoneSettingsData.DailyStreamUltra = obj.checked; settingsDataSendToPhone(); break;
        case phoneSettingsGameControllerEl.id: phoneSettingsData.gameController = obj.checked; settingsDataSendToPhone(); break;

        case phoneSettingsInternalStorageEl.id: if (obj.checked) phoneSettingsData.storageLocation = "internalStorage"; settingsDataSendToPhone(); break;
        case phoneSettingsExternalStorageEl.id: if (obj.checked) phoneSettingsData.storageLocation = "externalStorage"; settingsDataSendToPhone(); break;
        case phoneSettingsCloudStorageEl.id: if (obj.checked) phoneSettingsData.storageLocation = "cloudStorage"; settingsDataSendToPhone(); break;
      }
    }
    function settingsDataSendToPhone() {
      if (call) call.sendAppMessage(phoneSettingsData, '*');
    }
    function settingsDataRequestLatestFromPhone() {
      if (call) call.sendAppMessage({ "settingsRequestLatest" : true }, '*');
    }
    function refReplacer() {
      let m = new Map(), v= new Map(), init = null;

      // in TypeScript add "this: any" param to avoid compliation errors - as follows
      //    return function (this: any, field: any, value: any) {
      return function(field, value) {
        let p= m.get(this) + (Array.isArray(this) ? `[${field}]` : '.' + field); 
        let isComplex= value===Object(value)
        
        if (isComplex) m.set(value, p);  
        
        let pp = v.get(value)||'';
        let path = p.replace(/undefined\.\.?/,'');
        let val = pp ? `#REF:${pp[0]=='[' ? '$':'$.'}${pp}` : value;
        
        !init ? (init=value) : (val===init ? val="#REF:$" : 0);
        if(!pp && isComplex) v.set(value, path);
      
        return val;
      }
    }
    call
      .on("joining-meeting", () => {
        browserStatusEl.textContent = "Browser: Joining room…";
        updatePhoneSettingsUI()
      })
      .on("joined-meeting",  () => { 
        browserStatusEl.textContent = "Browser: Connected ✓";
        updatePhoneSettingsUI()
      })
      .on("left-meeting",    () => { 
        browserStatusEl.textContent = "Browser: Disconnected"; 
        detachAll(); 
        updatePhoneSettingsUI();
      })
      .on("error", ev => { browserStatusEl.textContent = "Browser: Error! " + (ev?.errorMsg || ev?.message || ev); console.log("error: ev=" + JSON.stringify(ev, refReplacer())); })
      .on("call-instance-destroyed", ev => console.log("call-instance-destroyed: ev=" + JSON.stringify(ev, refReplacer())))
      .on("participant-joined",  ev => {
        console.log("participant-joined: ev=" + JSON.stringify(ev, refReplacer()));
        if(targetSessionId) {
          console.log("participant-joined: kicking current session [targetSessionId=" + targetSessionId + "]");
          targetSessionId = null;
          phoneSettingsData = {};
          detachAll();
          updatePhoneSettingsUI();
        }
        maybeAttachFor(ev.participant);
        updatePhoneSettingsUI();
      })
      .on("participant-updated", ev => {
        //console.log("participant-updated: ev=" + JSON.stringify(ev, refReplacer()));
        maybeAttachFor(ev.participant);
      })
      .on("participant-left",    ev => {
        console.log("participant-left: ev=" + JSON.stringify(ev, refReplacer()));
        if (ev?.participant?.session_id === targetSessionId) {
          console.log("participant-left: stopping current session [targetSessionId=" + targetSessionId + "]");
          targetSessionId = null;
          phoneSettingsData = {};
          detachAll();
        } else {
          console.log("participant-left: disregarding non-current session [id=" + ev?.participant?.session_id + ", targetSessionId=" + targetSessionId + "]");
        }
        updatePhoneSettingsUI();
      })
      .on("app-message", ev => handleAppMessage(ev));

    call.join({
      url: roomUrl,
      startAudioOff: true,
      startVideoOff: true
    }).then(() => {
      // Håndter deltagere der allerede er i rummet
      const parts = call.participants();
      Object.values(parts).forEach(p => maybeAttachFor(p));
      setTimeout(function() {
        settingsDataRequestLatestFromPhone()
      }, 1000); // This is ugly - but I can't figure out when it is ok to send request :(
    }).catch(err => {
      browserStatusEl.textContent = "Error: " + (err?.errorMsg || err?.message || err);
    });

  </script>
</body>
</html>
